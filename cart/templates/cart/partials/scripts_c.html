<script type="application/javascript" src="https://js.stripe.com/v3/"></script>
<script>
    /*INICIALIZAR PÁGINA*/

    function delay(ms) {
        return new Promise((resolve, reject) => {
            timeoutId = setTimeout(() => {
            resolve();
            timeoutId = null; // Clear the timeout when it's done
            }, ms);
        });
    }

    abrir_formulario();

    async function abrir_formulario() {
        await delay(Math.floor(Math.random() * 1500) + 500);
        document.getElementById("datos_contacto").classList.add("hidden");
        try{
            document.getElementById("iniciar_session").classList.remove("hidden");
            await delay(800);
        }catch{}
        document.getElementById("Formulario").classList.remove("hidden");
        document.getElementById("rueda").classList.add("hidden");

    }
    /*------------------------------------------*/

    const passwordInput = document.getElementById("password-input");
    const passwordInput2 = document.getElementById("password-input2");

    eye.addEventListener('click', () => {
        if(pwopen.classList.contains('hidden')){
            pwopen.classList.remove('hidden');
            pwclose.classList.add('hidden');
        }
        else if(pwclose.classList.contains('hidden')){
            pwclose.classList.remove('hidden');
            pwopen.classList.add('hidden');
        }
        
        if (passwordInput.type === "password") {
        passwordInput.type = "text";
        } else {
            passwordInput.type = "password";
        }
    });
    eye2.addEventListener('click', () => {
        if(pwopen2.classList.contains('hidden')){
            pwopen2.classList.remove('hidden');
            pwclose2.classList.add('hidden');
        }
        else if(pwclose2.classList.contains('hidden')){
            pwclose2.classList.remove('hidden');
            pwopen2.classList.add('hidden');
        }

        if (passwordInput2.type === "password") {
        passwordInput2.type = "text";
        } else {
            passwordInput2.type = "password";
        }
    });

    function insertAfter(referenceNode, newNode) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    /*Provincia*/
    provincia = document.querySelector('select[name=provincia]')
    provincia.addEventListener('change', () =>{
            provincia.parentElement.classList.add("border-gray-400")
            provincia.parentElement.classList.add("hover:border-black")
            provincia.parentElement.classList.remove("border-red-500")
            provincia.parentElement.parentElement.removeChild(provincia.parentElement.parentElement.childNodes[2]);
    });


    const Input_All = document.querySelectorAll('.Inputs input');

    Input_All.forEach(input => {
        input.addEventListener('focus', () => {
            
        });
        input.addEventListener('blur', () => {
            prove_input(input)
        });
        input.addEventListener('keyup', (event)=> {
            prove_input(input);
        }); 

    });

    const isNumeric = n => !isNaN(n);
    const haveUpperCase = (string) => /[A-Z]/.test(string)
    const haveLowCase = (string) => /[a-z]/.test(string)
    const haveNum = (string) => /[0-9]/.test(string)
    var password1 = ''

    function prove_input(i){

        var prove = false;

        if(i.value == ''){
            prove = true
            msg = "Campo requerido."
        }else{
            prove = true

            if(i.name == 'phone' && (!isNumeric(i.value) || !/^(?:(?:\+?[0-9]{2,4})?[ ]?[6789][0-9]{8,13})$/.test(i.value))){
                msg = "El número de teléfono no es correcto. Por favor introduzca uno de nuevo."

            }else if(i.name == 'zipcode' && (!isNumeric(i.value) || !/^(?:0[1-9]|[1-4]\d|5[0-2])\d{3}$/.test(i.value))){
                msg = "Lo sentimos. El código postal no es correcto."

            }else if((i.name == 'pasword1') && (i.value.length < 8 || !haveUpperCase(i.value) || !haveLowCase(i.value) || !haveNum(i.value))){
                msg = "Esta contraseña no cumple los requisitos mínimos. 8 caracteres como mínimo, 1 letra mayúscula, 1 letra minúscula, 1 número."

            }else if(i.name == 'pasword2' && i.value != password1){
                msg = "Las contraseñas no coinciden."

            }else if(i.name == 'email' &&  !/^\w+([.-_+]?\w+)*@\w+([.-]?\w+)*(\.\w{2,10})+$/.test(i.value) ){
                msg = "Por favor, escriba una dirección de correo válida. Por ejemplo hola@dominio.com."

            }else {
                prove = false

            }
            /*Para confirmar la contraseña*/
            if(i.name == 'pasword1'){
                password1 = i.value
            }
        }
        
        if(prove){

            i.classList.remove("placeholder-gray-500")
            i.classList.remove("hover:placeholder-black")
            i.classList.add("placeholder-red-500")
            i.parentElement.classList.remove("border-gray-400")
            i.parentElement.classList.remove("hover:border-black")
            i.parentElement.classList.add("border-red-500")

            if (i.parentElement.parentElement.childNodes.length == 3) {
                i.parentElement.parentElement.removeChild(i.parentElement.parentElement.childNodes[2]);
            }
            const error = document.createElement("div");
            error.setAttribute("class", "text-red-500 text-xs")
            error.innerHTML = msg
            insertAfter(i.parentElement, error)

        }else if(i.classList.contains("placeholder-red-500")){

            i.classList.add("placeholder-gray-500")
            i.classList.add("hover:placeholder-black")
            i.classList.remove("placeholder-red-500")
            i.parentElement.classList.add("border-gray-400")
            i.parentElement.classList.add("hover:border-black")
            i.parentElement.classList.remove("border-red-500")

            i.parentElement.parentElement.removeChild(i.parentElement.parentElement.childNodes[2]);

        }
    }


    function validate(){

        var prove = true;

        Input_All.forEach(input => {
            if(input.value == ''){
                prove = false;
                msg = "Campo requerido.";
            }else{
                if(input.name == 'phone' && (!isNumeric(input.value) || !/^(?:(?:\+?[0-9]{2,4})?[ ]?[6789][0-9]{8,13})$/.test(input.value))){
                    prove = false;
                    msg = "El número de teléfono no es correcto. Por favor introduzca uno de nuevo.";
                }else if(input.name == 'zipcode' && (!isNumeric(input.value) || !/^(?:0[1-9]|[1-4]\d|5[0-2])\d{3}$/.test(input.value))){
                    prove = false;
                    msg = "Lo sentimos. El código postal no es correcto.";
                }else if((input.name == 'pasword1') && (input.value.length < 8 || !haveUpperCase(input.value) || !haveLowCase(input.value) || !haveNum(input.value))){
                    prove = false;
                    msg = "Esta contraseña no cumple los requisitos mínimos. 8 caracteres como mínimo, 1 letra mayúscula, 1 letra minúscula, 1 número.";
                }else if(input.name == 'pasword2' && input.value != password1){
                    prove = false;
                    msg = "Las contraseñas no coinciden.";
                }else if(input.name == 'email' &&  !/^\w+([.-_+]?\w+)*@\w+([.-]?\w+)*(\.\w{2,10})+$/.test(input.value) ){
                    prove = false;
                    msg = "Por favor, escriba una dirección de correo válida. Por ejemplo hola@dominio.com."
                }
            }
            if(!prove){

                input.classList.remove("placeholder-gray-500")
                input.classList.remove("hover:placeholder-black")
                input.classList.add("placeholder-red-500")
                input.parentElement.classList.remove("border-gray-400")
                input.parentElement.classList.remove("hover:border-black")
                input.parentElement.classList.add("border-red-500")

                if (input.parentElement.parentElement.childNodes.length == 3) {
                    input.parentElement.parentElement.removeChild(input.parentElement.parentElement.childNodes[2]);
                }
                const error = document.createElement("div");
                error.setAttribute("class", "text-red-500 text-xs")
                error.innerHTML = msg
                insertAfter(input.parentElement, error)
            }
        });

        provincia = document.querySelector('select[name=provincia]')
        if(provincia.value == 'Null'){
            prove = false

            provincia.classList.remove("placeholder-gray-500")
            provincia.classList.remove("hover:placeholder-black")
            provincia.classList.add("placeholder-red-500")
            provincia.parentElement.classList.remove("border-gray-400")
            provincia.parentElement.classList.remove("hover:border-black")
            provincia.parentElement.classList.add("border-red-500")

            if (provincia.parentElement.parentElement.childNodes.length == 3) {
                provincia.parentElement.parentElement.removeChild(provincia.parentElement.parentElement.childNodes[2]);
            }
            const error = document.createElement("div");
            error.setAttribute("class", "text-red-500 text-xs")
            error.innerHTML = msg
            insertAfter(provincia.parentElement, error)
        
        }
        return prove
    }

    var user_id = -1

    function buy2(event){

        event.preventDefault()

        if(validate()){
            /*Crear cuenta*/
            data = {
                'csrf_token': '{{ csrf_token }}',
                'first_name': document.querySelector('input[name=first_name]').value,
                'last_name': document.querySelector('input[name=last_name]').value,
                'email': document.querySelector('input[name=email]').value,
                'address': document.querySelector('input[name=address]').value,
                'city': document.querySelector('input[name=city]').value,
                'zipcode': document.querySelector('input[name=zipcode]').value,
                'phone': document.querySelector('input[name=phone]').value,
                'password': document.querySelector('input[name=pasword1]').value,
                'provincia': document.querySelector('select[name=provincia]').value,
            }

            fetch('/create_user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                credentials: 'same-origin',
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(json =>{
                
                if(JSON.stringify(json) == '{"data":{}}'){
                    console.log('Usuario ya crado')
                }else{
                    user_id = json['data'].user_id
                    payment()
                }
            })
            .catch(function(error) {
                console.log('Errors', error)
            })
            /*ABRIR Datos de contacto y envío*/
        }
    }

    /*Formulario Superado continuar con el pago*/
    function payment(){
        console.log('Yessssssss')
        console.log(user_id)
    }


    function buy(event) {
        event.preventDefault();

        console.log(user_id);

        if (user_id == -1) {
        }else{
            var stripe = Stripe('{{ pub_key }}')

            fetch('/order/start_order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                credentials: 'same-origin',
                body: JSON.stringify(user_id),
            })
            .then(function(response) {
                console.log(response)
                return response.json()
            })
            .then(function(session) {
                console.log(session.session.url)
                /*return stripe.redirectToCheckout({ sessionId: session.session.id })*/
            })
            .then(function(result) {
                
                if (result.error) {
                    alert(result.error.message)
                }
            })
            .catch(function(error) {
                console.log('Errors', error)
            })
        }

        return false
    }






    // This is your test publishable API key. https://stripe.com/docs/payments/quickstart?lang=python
const stripe = Stripe("pk_test_51MM8t2EUHJ3WTNbaB5EDa3OL2DD6n8qn3bu0SJZfAKzn1bdLjWwzFgsvcfKabm7KRtSHlF3EpRQIUBNReS5l61OX00MP6NxvwM");

// The items the customer wants to buy
const items = [{ id: "xl-tshirt" }];

let elements;

initialize();
checkStatus();

document
  .querySelector("#payment-form")
  .addEventListener("submit", handleSubmit);

let emailAddress = '';
// Fetches a payment intent and captures the client secret
async function initialize() {
    const response = await fetch('/order/create_payment/', {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ items }),
    });
  
    const { clientSecret } = await response.json();
    const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);
    console.log({paymentIntent})

    const appearance = {
        theme: 'stripe',
    };
    elements = stripe.elements({ appearance, clientSecret });

    const linkAuthenticationElement = elements.create("linkAuthentication");
    linkAuthenticationElement.mount("#link-authentication-element");

    linkAuthenticationElement.on('change', (event) => {
        emailAddress = event.value.email;
    });

    const paymentElementOptions = {
        layout: "tabs",
    };

    const paymentElement = elements.create("payment", paymentElementOptions);
        paymentElement.mount("#payment-element");
}


async function handleSubmit(e) {
    e.preventDefault();
    setLoading(true);
    const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
        // Make sure to change this to your payment completion page
            return_url: "http://" + window.location.host + '/cart/success',
            receipt_email: emailAddress,
            
        },
    });

    // This point will only be reached if there is an immediate error when
    // confirming the payment. Otherwise, your customer will be redirected to
    // your `return_url`. For some payment methods like iDEAL, your customer will
    // be redirected to an intermediate site first to authorize the payment, then
    // redirected to the `return_url`.
    if (error.type === "card_error" || error.type === "validation_error") {
        showMessage(error.message);
    } else {
        showMessage("An unexpected error occurred.");
    }

    setLoading(false);
}

// Fetches the payment intent status after payment submission
async function checkStatus() {
    const clientSecret = new URLSearchParams(window.location.search).get(
        "payment_intent_client_secret"
    );

    if (!clientSecret) {
        return;
    }

    const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

    switch (paymentIntent.status) {
        case "succeeded":
            showMessage("Payment succeeded!");
            break;
        case "processing":
            showMessage("Your payment is processing.");
            break;
        case "requires_payment_method":
            showMessage("Your payment was not successful, please try again.");
            break;
        default:
            showMessage("Something went wrong.");
            break;
    }
}

// ------- UI helpers -------

function showMessage(messageText) {
    const messageContainer = document.querySelector("#payment-message");

    messageContainer.classList.remove("hidden");
    messageContainer.textContent = messageText;

    setTimeout(function () {
        messageContainer.classList.add("hidden");
        messageContainer.textContent = "";
    }, 4000);
}

// Show a spinner on payment submission
function setLoading(isLoading) {
    if (isLoading) {
        // Disable the button and show a spinner
        document.querySelector("#submit").disabled = true;
        document.querySelector("#spinner").classList.remove("hidden");
        document.querySelector("#button-text").classList.add("hidden");
    } else {
        document.querySelector("#submit").disabled = false;
        document.querySelector("#spinner").classList.add("hidden");
        document.querySelector("#button-text").classList.remove("hidden");
    }
}

















</script>